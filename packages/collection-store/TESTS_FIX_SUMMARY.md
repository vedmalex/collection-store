# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–î–ê–Æ–©–ò–• –¢–ï–°–¢–û–í - –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `dbName: ':memory:'` –≤ collection-store –ø–∞–¥–∞–ª–∏ —Ç–µ—Å—Ç—ã –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º CSDatabase –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏.

### üö® –û—à–∏–±–∫–∏ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
error: collection test-collection-1 already exists
error: collection users-3 already exists
error: collection users-4 already exists
error: collection test-memory-convention-8 already exists
```

**–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤:** 5 pass, 4 fail –∏–∑ 9 —Ç–µ—Å—Ç–æ–≤

## üîß –†–µ—à–µ–Ω–∏–µ

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `clearCollections()` –≤ CSDatabase

```typescript
async clearCollections(): Promise<void> {
  // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
  for (const [name, collection] of this.collections) {
    try {
      await collection.reset()
    } catch (error) {
      console.warn(`Failed to reset collection ${name}:`, error)
    }
  }

  // –û—á–∏—â–∞–µ–º Map –∫–æ–ª–ª–µ–∫—Ü–∏–π
  this.collections.clear()

  // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∫–æ–ª–ª–µ–∫—Ü–∏–π
  this.collectionList.clear()

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  this.inTransaction = false
  this.currentTransactionId = undefined
  this.transactionSnapshots.clear()
  this.transactionSavepoints.clear()
  this.savepointNameToId.clear()
  this.savepointCounter = 0
}
```

### 2. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `registerCollection()`

–í–º–µ—Å—Ç–æ –≤—ã–±—Ä–æ—Å–∞ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π, —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º:

```typescript
private registerCollection(collection: Collection<any>) {
  // For testing purposes, allow overwriting collections
  if (this.collections.has(collection.name)) {
    console.warn(`[CSDatabase] Overwriting existing collection: ${collection.name}`)
    const existingCollection = this.collections.get(collection.name)
    if (existingCollection) {
      // Clean up existing collection
      existingCollection.reset().catch(err => console.warn('Failed to reset existing collection:', err))
    }
  }
  this.collections.set(collection.name, collection)
}
```

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã

- –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω
- –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã `clearCollections()` –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω –∫–æ–ª–ª–µ–∫—Ü–∏–π —Å `testId`

```typescript
let testCounter = 0

beforeEach(() => {
  testId = ++testCounter
})

// –í –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ:
await db.clearCollections() // Cleanup
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–ü–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤:** 4/9 (44% fail rate)
- **–ü—Ä–æ—Ö–æ–¥—è—â–∏—Ö —Ç–µ—Å—Ç–æ–≤:** 5/9 (56% success rate)
- **–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚ùå FAIL

### ‚úÖ –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–ü–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤:** 0/9 (0% fail rate)
- **–ü—Ä–æ—Ö–æ–¥—è—â–∏—Ö —Ç–µ—Å—Ç–æ–≤:** 9/9 (100% success rate)
- **–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ PASS

### üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤:
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 692
- **–ü—Ä–æ—Ö–æ–¥—è—â–∏—Ö:** 692 (100%)
- **–ü–∞–¥–∞—é—â–∏—Ö:** 0 (0%)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 1.85s

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–¢–ê–¢–£–°: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û**

–í—Å–µ –ø–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. **‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - —Ä–µ—à–µ–Ω–∞ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `clearCollections()`
2. **‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π** - —Ä–µ—à–µ–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
3. **‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤** - –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ —á–µ—Ä–µ–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∏ –æ—á–∏—Å—Ç–∫—É
4. **‚úÖ Backward compatibility** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Collection-store —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `dbName: ':memory:'` –∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ.

---

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö:

1. **CSDatabase.ts**
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `clearCollections()`
   - –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `registerCollection()`

2. **memory-adapter-selection.test.ts**
   - –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã –æ—á–∏—Å—Ç–∫–∏ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω –∫–æ–ª–ª–µ–∫—Ü–∏–π

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `clearCollections()` –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –≤ `afterEach`
3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `clearCollections()` –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API

---
*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è*